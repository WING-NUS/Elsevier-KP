<?xml version="1.0" encoding="UTF-8"?>
<Module>
    <ModulePrefs
            title="Keyphrase by WING.NUS"
            author_email="kanmy@comp.nus.edu.sg">
        <Require feature="sciverse" />
        <Require feature="ScienceDirect" />
        <Require feature="dynamic-height" />
    </ModulePrefs>
    <Content type="html" view="canvas,profile"><![CDATA[<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0//EN">  
  <body onload="getContextInfo()">
  <style type="text/css">
  span.ex1 {
    font:10px arial,sans-serif;
  }
  </style>
  <script type="text/javascript">

 var articleDOI;
 var secureAuthToken;

 /*
  * This function calls the container to get the current article content.
  */
 function getContextInfo()
 {
   gadgets.sciverse.getContextInfo(contextInfoCallback);
 }

 function contextInfoCallback(response) {
   articleDOI = response["doi"];
   secureAuthtoken = response["secureAuthtoken"];
   var params = {};
   var postdata = {doi: articleDOI};
   params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
   params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
   params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postdata);
   document.getElementById("contextInfo").innerHTML = "<span class=\"ex1\">Checking cache for DOI: " + articleDOI + ". Please wait...</span>";

   var cacheUrl = "http://wing.comp.nus.edu.sg/elsevier-kp/cache.cgi";
   gadgets.io.makeRequest(cacheUrl, cacheCallback, params);
 }

 function cacheCallback(response) {
   if (response.text != "0\n") {
     document.getElementById("contextInfo").innerHTML = response.text
   } else {
     // get DOI from context   
     document.getElementById("contextInfo").innerHTML = "<span class=\"ex1\">Retrieving text of article with DOI: " + articleDOI + ". Please wait...</span>";

     var requestHeaders = {};
     requestHeaders['X-ELS-APIKey'] = "2cb7e21fa1564348861fff2db68f1da8";
     requestHeaders['X-ELS-Authtoken'] = secureAuthtoken; // fetch authtoken from context call
     requestHeaders['Accept'] = "text/xml";

     var contentSearchUrl = "http://api.elsevier.com/content/article/DOI:" + articleDOI + "?view=FULL";
     gadgets.sciverse.makeContentApiRequest(contentSearchUrl, articleCallback, requestHeaders);
   }
 }

 function articleCallback(response) {
   document.getElementById("contextInfo").innerHTML = "<span class=\"ex1\">Got article text, forwarding to service, please wait...</span>";

   var params = {};
   var postdata = {query: response["text"], doi: articleDOI};
   params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
   params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.TEXT;
   params[gadgets.io.RequestParameters.POST_DATA] = gadgets.io.encodeValues(postdata);

   var keyphraseUrl = "http://wing.comp.nus.edu.sg/elsevier-kp/keyphrase.cgi";
   gadgets.io.makeRequest(keyphraseUrl, keyphraseCallback, params);
 }

 function keyphraseCallback(response) {
   document.getElementById("contextInfo").innerHTML = response.text +  "<br/><span class=\"ex1\"><a id=\"keyphraseAction\" href=\"javascript:void(0);\" onclick=\"getContextInfo();\">Re-run Keyphrase again</a></span>" 
 }
   </script>
   <div id="contextInfo" style="display:block"></div>
   </body>
   ]]></Content>
</Module>
